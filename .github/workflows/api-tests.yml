name: æ—¥æœ¬èªç¸¦æ›¸ãAPI ãƒ†ã‚¹ãƒˆ

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'main.py'
      - 'test_api.py'
      - 'requirements.txt'
      - '.github/workflows/api-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'main.py'
      - 'test_api.py'
      - 'requirements.txt'
      - '.github/workflows/api-tests.yml'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

# ç’°å¢ƒå¤‰æ•°
env:
  API_TOKEN: ${{ secrets.API_TOKEN || 'your-secret-token-here' }}
  PYTHON_VERSION: '3.11'

jobs:
  api-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      # PostgreSQLç­‰ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¿…è¦ãªå ´åˆã¯ã“ã“ã«è¿½åŠ 

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          fonts-noto-cjk \
          fonts-liberation \
          libnss3-dev \
          libatk-bridge2.0-dev \
          libdrm2 \
          libxkbcommon-dev \
          libgtk-3-dev \
          libatspi2.0-dev \
          xvfb

    - name: Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Playwrightç”¨ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        playwright install chromium

    - name: ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
      run: |
        ls -la fonts/ || echo "ãƒ•ã‚©ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        if [ ! -f "fonts/GenEiAntiqueNv5-M.ttf" ]; then
          echo "è­¦å‘Š: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

    - name: APIã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
      run: |
        python main.py &
        sleep 10  # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…ã¡

    - name: APIã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ç¢ºèª
      run: |
        curl -f http://localhost:8000/health || exit 1
        echo "APIã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"

    - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always()  # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test_output/
          test_results/
        retention-days: 7

    - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
      if: always()
      run: |
        echo "## API ãƒ†ã‚¹ãƒˆçµæœ ğŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "test_results/test_result_*.json" ]; then
          RESULT_FILE=$(ls -t test_results/test_result_*.json | head -n 1)
          SUCCESS_RATE=$(python -c "
import json
with open('$RESULT_FILE', 'r', encoding='utf-8') as f:
    data = json.load(f)
    print(f'{data[\"success_rate\"]:.1f}%')
")
          TOTAL_TESTS=$(python -c "
import json
with open('$RESULT_FILE', 'r', encoding='utf-8') as f:
    data = json.load(f)
    print(data['total_tests'])
")
          SUCCESS_COUNT=$(python -c "
import json
with open('$RESULT_FILE', 'r', encoding='utf-8') as f:
    data = json.load(f)
    print(data['success_count'])
")

          echo "- **æˆåŠŸç‡**: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          echo "- **ç·ãƒ†ã‚¹ãƒˆæ•°**: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **æˆåŠŸæ•°**: $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤±æ•—æ•°**: $((TOTAL_TESTS - SUCCESS_COUNT))" >> $GITHUB_STEP_SUMMARY

          if [ "$SUCCESS_RATE" = "100.0%" ]; then
            echo "- âœ… **å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âŒ **ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“**" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœã¯ Artifacts ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã”ç¢ºèªãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY

  # æœ¬æ ¼çš„ãªDockerç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ
  docker-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã®ã¿

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Docker Composeã§ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’èµ·å‹•
      run: |
        docker-compose -f docker-compose.yml up -d

    - name: ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•å¾…ã¡
      run: |
        echo "ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
        for i in {1..30}; do
          if curl -f http://localhost:8000/health; then
            echo "ã‚³ãƒ³ãƒ†ãƒŠãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"
            break
          fi
          echo "å¾…æ©Ÿä¸­... ($i/30)"
          sleep 10
        done

    - name: Dockerç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      if: always()
      run: |
        docker-compose -f docker-compose.yml down
        docker system prune -f