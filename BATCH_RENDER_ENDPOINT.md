# バッチレンダリングエンドポイント提案

## 背景

`POST /render` は単一のテキストを画像化する設計で、リクエストごとに Playwright コンテキストとフォントが読み込まれる。大量アクセスが想定される環境では、これらの初期化コストが支配的になりスループットが低下する。

## 提案概要

- 新規エンドポイント `POST /render/batch` を追加し、複数テキストをまとめて処理する。
- 1 リクエスト内で Playwright とフォントを一度だけ初期化し、各テキストを順次レンダリングすることでオーバーヘッドを削減する。
- 既存の `POST /render` は互換性維持のためそのまま提供する。

## API 仕様

### リクエスト

- `items` 配列の最大長は 50。超過した場合は 400 Bad Request を返す。
- `defaults` で共通のレンダリングパラメータを指定でき、各アイテムはそれを上書きする。

```jsonc
{
  "defaults": {
    "font": "gothic",
    "font_size": 20
  },
  "items": [
    {
      "text": "吾輩は猫である。名前はまだ無い。",
      "font": "mincho",
      "font_size": 24,
      "line_height": 1.8,
      "letter_spacing": 0.1,
      "padding": 30,
      "use_tategaki_js": false,
      "max_chars_per_line": 10
    },
    {
      "text": "こんにちは世界"
    },
    {
      "text": "フォントが存在しない例",
      "font": "unknown_font"
    }
  ]
}
```

### レスポンス

- 各結果オブジェクトは成功時に画像情報を、失敗時に `error` フィールドを返す。

```jsonc
{
  "results": [
    {
      "image_base64": "...",
      "width": 400,
      "height": 600,
      "processing_time_ms": 1234.5,
      "trimmed": true
    },
    {
      "image_base64": "...",
      "width": 120,
      "height": 200,
      "processing_time_ms": 456.7,
      "trimmed": false
    },
    {
      "error": {
        "code": "FONT_NOT_FOUND",
        "message": "font 'unknown_font' is not available"
      }
    }
  ]
}
```

## 実装方針

- **ドメイン層分離**: レンダリング処理をサービスクラスに抽出し、単一テキストとバッチ処理の両方で再利用できるようにする。
- **初期化の共通化**: ブラウザ・ページ・フォント読み込みはリクエスト単位で一度のみ実行する。
- **パラメータ共通化**: `defaults` を各アイテムにマージし、冗長な指定を避ける。
- **エラーハンドリング**: 各アイテムの失敗が他に波及しないよう、結果配列には `error` フィールドを含める。HTTP ステータスは 200 を維持。
- **並列処理の検討**: 同一ブラウザコンテキスト内でのシーケンシャル処理を基本とし、将来的な並列化に備えて非同期タスク化可能な設計にする。
- **レート制御**: 既存の `MAX_CONCURRENCY` 制御を流用し、バッチ内でも過剰な同時実行を避ける。

## 想定される効果

- フォント読み込みと Playwright 起動回数の削減によるレイテンシ短縮。
- 大量リクエスト時の CPU / メモリ使用量の安定化。
- クライアント側で複数文字列をまとめて送信でき、ネットワーク往復回数が減少。

## 次のステップ

1. サービスクラス抽出と `POST /render` のリファクタリング。
2. `POST /render/batch` の追加実装と単体テスト整備。
3. README などドキュメントへのエンドポイント追記。
4. 負荷テストによる効果検証と最適なバッチサイズの調整。
